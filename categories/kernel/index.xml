<?xml version="1.0" encoding="utf-8" standalone="yes"?><?xml-stylesheet href="/feed_style.xsl" type="text/xsl"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="https://www.rssboard.org/media-rss">
  <channel>
    <title>Kernel on sorgDream&#39;s Blog</title>
    <link>https://blog.sorgdream.com/categories/kernel/</link>
    <description>Recent content in Kernel on sorgDream&#39;s Blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <copyright>sorgDream - [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/)</copyright>
    <lastBuildDate>Sat, 05 Aug 2023 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.sorgdream.com/categories/kernel/index.xml" rel="self" type="application/rss+xml" /><icon>https://blog.sorgdream.com/avatar.jpg</icon>
    
    
    <item>
      <title>KernelSU内核编译</title>
      <link>https://blog.sorgdream.com/posts/kernelsu/</link>
      <pubDate>Sat, 05 Aug 2023 00:00:00 +0000</pubDate>
      
      <guid>https://blog.sorgdream.com/posts/kernelsu/</guid>
      <description><![CDATA[<h2 id="环境搭建">环境搭建</h2>
<p>搭建编译所需的环境</p>
<h3 id="系统安装">系统安装</h3>
<p>教程基于ubuntu，你可以选择实机安装或者使用wsl2,如何安装请看<a href="https://learn.microsoft.com/zh-cn/windows/wsl/install">使用 WSL 在 Windows 上安装 Linux</a></p>
<blockquote>
<p>注：wsl将系统各盘挂载至<code>/mnt</code>目录，通过此挂载点可以实现文件传输</p>
</blockquote>
<h3 id="编译环境">编译环境</h3>
<p>使用以下命令安装所需软件包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo apt install -y bc bison build-essential curl flex g++-multilib gcc-multilib <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                    git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                    lib32z1-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                    libssl-dev libxml2 libxml2-utils lzop pngcrush schedtool <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                    squashfs-tools xsltproc zip zlib1g-dev unzip  
</span></span></code></pre></div><p>注: 若使用其他发行版或有部分软件包找不到，可以暂时忽略，等编译出现如<code>xxx not found</code>的错误时再安装</p>
<h3 id="系统代理">系统代理</h3>
<p>如果你的设备能够直连Github，并且速度还不错，那你可以忽视这一步</p>
<p>我们使用clash作为代理工具</p>
<ol>
<li>
<p>可以使用<a href="https://github.com/clash-verge-rev/clash-verge-rev">clash-verge-rev</a>或<a href="https://github.com/LibNyanpasu/clash-nyanpasu">clash-nyanpasu</a></p>
</li>
<li>
<p>具体配置不再赘述，其他代理客户端也行，具体看代理提供商支持哪些协议</p>
</li>
<li>
<p>使用以下命令设置终端代理</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>export https_proxy<span style="color:#f92672">=</span>http://127.0.0.1:7890 http_proxy<span style="color:#f92672">=</span>http://127.0.0.1:7890 all_proxy<span style="color:#f92672">=</span>socks5://127.0.0.1:7891
</span></span></code></pre></div><h2 id="源码下载">源码下载</h2>
<p>现在开始下载所需的内核源码和工具，我们最好创建一个工作目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>mkdir -p kernel  <span style="color:#f92672">&amp;&amp;</span> cd kernel <span style="color:#75715e">#创建并进入工作目录</span>
</span></span><span style="display:flex;"><span>mkdir -p toolchains  <span style="color:#75715e">#工具链目录</span>
</span></span><span style="display:flex;"><span>mkdir -p source  <span style="color:#75715e">#内核源码目录</span>
</span></span></code></pre></div><h3 id="内核源码">内核源码</h3>
<p>如果你是小米用户，你可以试着下官方的源码，不过官方的源码可能不能成功编译，而且年久失修，大部分新机都没有公布源码，所以还是建议使用类原生的源码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>官方源码仓库
</span></span><span style="display:flex;"><span>https://github.com/MiCode/Xiaomi_Kernel_OpenSource
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>如果要下载的话请使用 git 命令
</span></span><span style="display:flex;"><span>git clone --depth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> https://github.com/MiCode/Xiaomi_Kernel_OpenSource -b cannon-r-oss  
</span></span></code></pre></div><p><code>cannon-r-oss</code>是作者的手机代号，需将<code>cannon-r-oss</code>换成自己源码的分支</p>
<p>类原生的话就简单多了，点击仓库右上角的<strong>code</strong>,把HTTPS的链接复制下来</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone xxx.git  <span style="color:#75715e"># xxxxxxxx.git换成自己的链接</span>
</span></span></code></pre></div><h3 id="添加kernelsu">添加KernelSU</h3>
<blockquote>
<p>KernelSU 1.0 及更高版本已经不再支持非 GKI 内核，最后的支持版本为 v0.9.5，请注意使用正确的版本</p>
</blockquote>
<p>使用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -LSs <span style="color:#e6db74">&#34;https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh&#34;</span> | bash -s v0.9.5
</span></span></code></pre></div><p>将KernelSU-v0.9.5添加到内核源码树
<!-- raw HTML omitted -->然后需要编辑你的配置文件，通常在<code>arch/arm64/configs/</code>，较新的机型也可能在<code>arch/arm64/configs/vendor/</code></p>
<p>进入文件夹，找到类似<code>设备代号_defconfig</code>的文件，比如我的代号是<strong>cannon</strong>，配置文件就是<code>cannon_defconfig</code></p>
<p>使用任意编辑器打开你的配置文件，查找是否开启以下配置
<!-- raw HTML omitted -->如果没有开启相关的配置，需要手动添加</p>
<pre tabindex="0"><code>CONFIG_KPROBES=y
CONFIG_HAVE_KPROBES=y
CONFIG_KPROBE_EVENTS=y
</code></pre><h3 id="工具链下载">工具链下载</h3>
<p>作者使用zys-clang12和gcc4.9进行编译
<!-- raw HTML omitted -->因为zyc-clang需要下载压缩包并解压，所以我们先使用<strong>git</strong>下载gcc</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9.git
</span></span></code></pre></div><p>选择任意方式下载 zyc-clang</p>
<pre tabindex="0"><code>https://github.com/ZyCromerZ/Clang/releases/download/12.0.1-20230207-release/Clang-12.0.1-20230207.tar.gz
</code></pre><p>下载完成后用<code>tar -zxvf Clang-xxxx.tar.gz</code>解压</p>
<p>如果觉得目录太常不方便的话，可以用<strong>mv</strong>命令重命名文件夹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>mv &lt;原名称&gt; &lt;你想改的名称&gt;   
</span></span></code></pre></div><h2 id="编译脚本">编译脚本</h2>
<p>一般我们会用一个编译脚本设置环境变量、配置文件等
<!-- raw HTML omitted -->我的脚本是<del>抄</del>参考别人教程</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>vim build.sh <span style="color:#75715e">#创建编译脚本 </span>
</span></span></code></pre></div><p>写入以下内容</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>starttime<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>date +<span style="color:#e6db74">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>export ARCH<span style="color:#f92672">=</span>arm64
</span></span><span style="display:flex;"><span>export SUBARCH<span style="color:#f92672">=</span>arm64
</span></span><span style="display:flex;"><span>make O<span style="color:#f92672">=</span>out cannon_defconfig
</span></span><span style="display:flex;"><span>              make -j8 O<span style="color:#f92672">=</span>out <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    NM<span style="color:#f92672">=</span>~/kernel/toolchains/clang-12/bin/llvm-nm <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    OBJCOPY<span style="color:#f92672">=</span>~/kernel/toolchains/clang-12/bin/llvm-objcopy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    LD<span style="color:#f92672">=</span>~/kernel/toolchains/clang-12/bin/ld.lld <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        CROSS_COMPILE<span style="color:#f92672">=</span>~/kernel/toolchains/clang-12/bin/aarch64-linux-gnu- <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        CROSS_COMPILE_ARM32<span style="color:#f92672">=</span>~/kernel/toolchains/gcc-arm-4.9/bin/arm-linux-androideabi- <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        CC<span style="color:#f92672">=</span>~/kernel/toolchains/clang-12/bin/clang <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        AR<span style="color:#f92672">=</span>~/kernel/toolchains/clang-12/bin/llvm-ar <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        OBJDUMP<span style="color:#f92672">=</span>~/kernel/toolchains/clang-12/bin/llvm-objdump <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        STRIP<span style="color:#f92672">=</span>~/kernel/toolchains/clang-12/bin/llvm-strip
</span></span><span style="display:flex;"><span>        2&gt;&amp;<span style="color:#ae81ff">1</span> | tee error.log
</span></span><span style="display:flex;"><span>endtime<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>date +<span style="color:#e6db74">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>start_seconds<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>date --date<span style="color:#f92672">=</span><span style="color:#e6db74">&#34; </span>$starttime<span style="color:#e6db74">&#34;</span> +%s<span style="color:#66d9ef">)</span>;
</span></span><span style="display:flex;"><span>end_seconds<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>date --date<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$endtime<span style="color:#e6db74">&#34;</span> +%s<span style="color:#66d9ef">)</span>;
</span></span><span style="display:flex;"><span>echo Start: $starttime.
</span></span><span style="display:flex;"><span>echo End: $endtime.
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Build Time: &#34;</span><span style="color:#66d9ef">$((</span>end_seconds-start_seconds<span style="color:#66d9ef">))</span><span style="color:#e6db74">&#34;s.&#34;</span>
</span></span></code></pre></div><p>需要注意的是，<code>cannon_defconfig</code>配置文件的路径已经在<code>arch/arm64/configs/</code></p>
<p>假设你的配置文件是<code>arch/arm64/configs/example_defconfig</code>那你只需要填写<code>example_defconfig</code>即可</p>
<p>但如果你的配置文件位于<code>arch/arm64/configs/vendor/example_defconfig</code>则需要填写<code>vendor/example_defconfig</code></p>
<h2 id="开始编译">开始编译</h2>
<p>用<code>chmod +x build.sh</code>添加执行权限，<code>./build.sh</code>执行编译脚本，产出在<code>out/arch/arm64/boot</code>目录</p>
<h2 id="打包内核">打包内核</h2>
<p>能来到这一步，你应该能成功编译出内核，恭喜你，接下来我们需要将它打包成boot或内核刷入</p>
<h3 id="anykernel3">AnyKernel3</h3>
<p>项目地址：https://github.com/osm0sis/AnyKernel3</p>
<p>用<strong>git</strong>下载AnyKernel3</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/osm0sis/AnyKernel3.git
</span></span></code></pre></div><p>你需要把产出的Image放到AnyKernel3的根目录，然后编辑<code>anykernel.sh</code>
<!-- raw HTML omitted -->需要改的是以下几点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kernel.string<span style="color:#f92672">=</span>KernelSU-cannon-inuyasha <span style="color:#75715e">#内核名称</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>.devicecheck<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#75715e">#设备检测，为0时关闭</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>.modules<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>.systemless<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>.cleanup<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>.cleanuponabort<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>device.name1<span style="color:#f92672">=</span>cannon  <span style="color:#75715e">#设备代号，可以设置多个</span>
</span></span><span style="display:flex;"><span>device.name2<span style="color:#f92672">=</span>cannong
</span></span><span style="display:flex;"><span>device.name3<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>device.name4<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>supported.versions<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>supported.patchlevels<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>supported.vendorpatchlevels<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>block<span style="color:#f92672">=</span>auto;   
</span></span><span style="display:flex;"><span>is_slot_device<span style="color:#f92672">=</span>auto;  
</span></span><span style="display:flex;"><span>ramdisk_compression<span style="color:#f92672">=</span>auto; 
</span></span><span style="display:flex;"><span>patch_vbmeta_flag<span style="color:#f92672">=</span>auto; 
</span></span></code></pre></div><p>配置完后使用<code>zip -r9 UPDATE-AnyKernel3.zip * -x .git README.md *placeholder</code>即可打包内核</p>
<p>如果使用zsh，可能会报错<code>not matches found</code>，只需要在<code>.zshrc</code>中添加</p>
<pre tabindex="0"><code>setopt no_nomatch
</code></pre><p>然后再<code>source ~/.zshrc</code>即可解决</p>
<h3 id="magiskboot">MagiskBoot</h3>
<p>如果你不喜欢用anykernel3，你也可以提取原版的boot.img使用编译出来的image替换原厂kernel</p>
<ol>
<li>首先到<a href="https://github.com/topjohnwu/Magisk/releases">Magisk</a>下载magisk.apk,重命名为.zip并解压</li>
<li>把解压后的<code>Magisk-v26.1/lib/arm64-v8a/libmagiskboot.so</code>文件，用 adb push 到手机</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>adb push Magisk-v26.1/lib/arm64-v8a/libmagiskboot.so /data/local/tmp/magiskboot 
</span></span></code></pre></div><p><code>Magisk-v26.1</code>需要改成下载的版本号</p>
<ol start="3">
<li>按照上面的方法把提取的boot.img和编译出的Image都push到手机</li>
<li>用<code>adb shell</code>进入adb，然后进入手机<code>/data/local/tmp</code>/目录，赋予magiskboot可执行权限<code>chmod +x magiskboot</code></li>
<li>执行<code>./magiskboot unpack boot.img</code>解包boot.img得到kernel文件</li>
<li>用<strong>Image</strong>替换<strong>kernel</strong><code>mv -f Image kernel</code></li>
<li>最后执行<code>./magiskboot repack boot.img</code>命令重新打包boot.img，得到<strong>new-boot.img</strong>，备份原厂boot后在fastboot中刷入即</li>
</ol>
<h2 id="拓展">拓展</h2>
<p>如果kprobe不正常工作，就会出现无限重启，不开机，替换boot后仍显示不支持等错误，接下来我们将手动修改源码集成ksu</p>
<p>首先让我们验证是否为kprobe的问题，</p>
<ol>
<li>首先用vim打开<code>KernelSU/kernel/ksu.c</code></li>
<li>找到<code>ksu_enable_sucompat() 和 ksu_enable_ksud()</code>这两行，使用<code>//</code>注释掉</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// ksu_enable_sucompat();
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ksu_enable_ksud()
</span></span></span></code></pre></div><p>就像这样</p>
<p>重新编译你的内核，看能否开机，如果能正常开机就是kprobe的问题，如果还是不能开机，检查你的源码是否适用你的系统</p>
<h3 id="修改内核源码">修改内核源码</h3>
<ol>
<li>使用这条命添加KSU</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -LSs <span style="color:#e6db74">&#34;https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh&#34;</span> | bash -
</span></span></code></pre></div><ol start="2">
<li>因为要改的比较多，推荐去看<a href="https://kernelsu.org/zh_CN/guide/how-to-integrate-for-non-gki.html">官方文档</a>，写的比较详细</li>
</ol>
<h3 id="bugreport">BugReport</h3>
<p>如果手动集成还是失败，你可以去Github提供一个<a href="https://github.com/tiann/KernelSU/issues/new/choose">BugReport</a>给作者，在管理其设置，发送日志即可发送错误日志</p>
<h3 id="docker支持">Docker支持</h3>
<p>在手机终端中执行<a href="https://github.com/moby/moby/blob/master/contrib/check-config.sh">check-config.sh</a>脚本，将所有<code>missing</code>的配置添加到内核配置文件，并重新编译内核</p>
<h2 id="参考部分引用">参考|部分引用</h2>
<p><a href="https://kernelsu.org/zh_CN/guide/how-to-integrate-for-non-gki.html">如何为非 GKI 内核集成 KernelSU </a></p>
<p><a href="https://blog.ticks.cc/posts/id/ef0vy/">红米K40内核KernelSU编译</a></p>
<p><a href="https://zixijian.github.io/2021/01/15/008.html"> 手机端编译安卓内核</a></p>]]></description>
      
    </item>
    
    
  </channel>
</rss>

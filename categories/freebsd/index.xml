<?xml version="1.0" encoding="utf-8" standalone="yes"?><?xml-stylesheet href="/feed_style.xsl" type="text/xsl"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="https://www.rssboard.org/media-rss">
  <channel>
    <title>FreeBSD on sorgDream&#39;s Blog</title>
    <link>https://blog.sorgdream.com/categories/freebsd/</link>
    <description>Recent content in FreeBSD on sorgDream&#39;s Blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <copyright>sorgDream - [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/)</copyright>
    <lastBuildDate>Wed, 10 Jul 2024 08:27:11 +0800</lastBuildDate><atom:link href="https://blog.sorgdream.com/categories/freebsd/index.xml" rel="self" type="application/rss+xml" /><icon>https://blog.sorgdream.com/avatar.jpg</icon>
    
    
    <item>
      <title>Wifibox的配置与使用</title>
      <link>https://blog.sorgdream.com/posts/wifibox/</link>
      <pubDate>Wed, 10 Jul 2024 08:27:11 +0800</pubDate>
      
      <guid>https://blog.sorgdream.com/posts/wifibox/</guid>
      <description><![CDATA[<p>最近几天，我在<code>Redmi Book Pro 14s</code>上安装了<code>FreeBSD 14.1-RELEASE</code>，也算是体验了一把UNIX哲学，但因FreeBSD的驱动太过匮乏了，导致我的安装并不顺利，也就有了这篇文章</p>
<h2 id="bhyve">bhyve</h2>
<blockquote>
<p>bhyve，发音为“beehive”，是 FreeBSD 的虚拟机管理程序 / 虚拟机管理器，支持带有“POPCNT”（POPulation Count）功能的 Intel 和 AMD 处理器上的多种客户操作系统，以及在实验中支持 gic0：ARM Generic Interrupt Controller v3.0 功能的 ARM64/aarch64 处理器</p>
<p>bhyve 支持多种存储和网络后端、UEFI、FreeBSD 加载器和 GRUB 启动、PCI 直通 (PPT)、集成 VNC 和 9pfs 服务器以及更多功能</p>
</blockquote>
<h2 id="wifibox">Wifibox</h2>
<blockquote>
<p>bhyve supports passing of host PCI devices to a virtual machine for its exclusive use of them.</p>
</blockquote>
<p>Wifibox则是借助其PCI直通技术，部署了一个 Linux 客户机，借助 PCI 直通技术驱动 FreeBSD 主机系统上的无线网卡</p>
<p>Wifibox的日志位于<code>/var/run/wifibox/appliance/log</code>，可以很方便地观察它的运行状态</p>
<h2 id="配置">配置</h2>
<p>我的网卡是<code>RTL8852be</code>，用<code>ifconfig</code>查看只有一个设备，其ip为<code>127.0.0.1</code>，若网卡在FreeBSD下有驱动支持，则需要额外禁用自带驱动</p>
<h3 id="安装-wifibox">安装 Wifibox</h3>
<ol>
<li>因为安装需要网络，我们将数据线插入电脑，开启USB网络共享，用<code>ifconfig</code>查看是否识别到设备<code>ue0</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dhclient ue0 <span style="color:#75715e"># 获取ip</span>
</span></span></code></pre></div><p>连接完后安装 Wifibox</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pkg install wifibox-rtw89 wifibox-alpine-rtw89
</span></span><span style="display:flex;"><span>pkg install sysutils/bhyve+
</span></span><span style="display:flex;"><span>pkg install gtar patchelf squashfs-tools-ng
</span></span><span style="display:flex;"><span>pkg install grub2-bhyve socat
</span></span><span style="display:flex;"><span>pkg install wpa_supplicant
</span></span></code></pre></div><ol start="2">
<li>用<code>pciconf -lv | less</code>查看设备，找到<code>class</code>为<code>network</code>的设备，并将其填写至<code>/usr/local/etc/wifibox/bhyve.conf</code></li>
</ol>
<pre tabindex="0"><code>none1@pci0:1:0:0 clash=....
    vendor = &#39;Realtek Semiconductor Co., Ltd.&#39;
    device = &#39;RTL8852BE PCIe 802.11ax ...&#39;
    class  = network
</code></pre><p>比如我这里显示为<code>0:1:0:0</code>，就将<code>1/0/0</code>填写到<code>/usr/local/etc/wifibox/bhyve.conf</code>的<code>passthru=</code>中</p>
<ol start="3">
<li>在<code> /etc/rc.conf</code>中写入以下配置启用Wifibox</li>
</ol>
<pre tabindex="0"><code class="language-rc.conf" data-lang="rc.conf">wifibox_enable=&#34;YES&#34;
ifconfig_wifibox0=&#34;SYNCDHCP&#34;
</code></pre><p>一些教程中会将以下两条配置也添加进<code>/etc/rc.conf</code>，但在我的设备中会导致网络不可用</p>
<pre tabindex="0"><code class="language-rc.conf" data-lang="rc.conf">background_dhclient_wifibox0=&#34;YES&#34;
defaultroute_delay=&#34;0&#34;
</code></pre><p>最后，将以下内容添加到<code>/boot/loader.rc</code></p>
<pre tabindex="0"><code>hw.vmm.amdvi.enable=1 
</code></pre><ol start="4">
<li>使用 wpa_passphrase 生成网络配置</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wpa_passphrase &lt;网络名称&gt; &lt;密码&gt; &gt; /etc/wpa_supplicant.conf
</span></span></code></pre></div><p>将配置复制到 Wifibox</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cp /etc/wpa_supplicant.conf /usr/local/etc/wifibox/wpa_supplicant/
</span></span></code></pre></div><ol start="5">
<li>
<p>这时候就应该重启了，但在我的网卡上，必须在启动时获取<code>Wifibox0</code>的ip，否则网络将无法工作</p>
<p>详情见 <a href="https://github.com/pgj/freebsd-wifibox/issues/54">support Realtek 8852BE wifi card?</a></p>
</li>
</ol>
<p>根据作者的方法，需要将<code>/sbin/dhclient wifibox0</code>添加进<code>/etc/rc.local</code>以解决此问题</p>
<h2 id="总结">总结</h2>
<p>这几天的使用，给我印象最深的是FreeBSD的精简和稳定性，每个软件包包的大小能控制得很好，ZFS和Raid Z挺适合用于服务器，希望FreeBSD能越来越好。</p>
]]></description>
      
    </item>
    
    
  </channel>
</rss>
